<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Damas Online con Firebase</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
        }

        .game-area {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            padding: 20px;
        }

        .auth-section, .game-section, .players-section {
            flex: 1;
            min-width: 300px;
        }

        .section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .board {
            width: 400px;
            height: 400px;
            margin: 0 auto;
            border: 3px solid #2c3e50;
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
        }

        .cell {
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .cell.light {
            background-color: #f0d9b5;
        }

        .cell.dark {
            background-color: #b58863;
        }

        .cell.possible-move {
            background-color: rgba(52, 152, 219, 0.5) !important;
        }

        .piece {
            width: 80%;
            height: 80%;
            border-radius: 50%;
            border: 2px solid #2c3e50;
            transition: all 0.3s ease;
        }

        .piece.red {
            background: linear-gradient(145deg, #e74c3c, #c0392b);
        }

        .piece.black {
            background: linear-gradient(145deg, #2c3e50, #34495e);
        }

        .piece.king::after {
            content: "‚ôî";
            color: gold;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        .piece.selected {
            box-shadow: 0 0 0 3px gold;
            transform: scale(1.1);
        }

        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            transition: background 0.3s ease;
        }

        button:hover {
            background: #2980b9;
        }

        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        input {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .player-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .player-item {
            padding: 10px;
            margin: 5px 0;
            background: white;
            border-radius: 5px;
            border-left: 4px solid #3498db;
        }

        .game-info {
            text-align: center;
            padding: 10px;
            background: #ecf0f1;
            border-radius: 5px;
            margin: 10px 0;
        }

        .current-player {
            font-weight: bold;
            color: #e74c3c;
        }

        .chat-box {
            height: 150px;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            overflow-y: auto;
            margin: 10px 0;
            background: white;
        }

        .message {
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
        }

        .message.own {
            background: #d4edda;
            text-align: right;
        }

        .message.other {
            background: #f8d7da;
        }

        @media (max-width: 768px) {
            .game-area {
                flex-direction: column;
            }
            
            .board {
                width: 300px;
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>‚ôüÔ∏è Damas Online con Firebase</h1>
        </header>

        <div class="game-area">
            <!-- Secci√≥n de Autenticaci√≥n -->
            <div class="auth-section">
                <div class="section">
                    <h2>üîê Autenticaci√≥n</h2>
                    <div id="auth-buttons">
                        <input type="email" id="email" placeholder="Email" />
                        <input type="password" id="password" placeholder="Contrase√±a" />
                        <button onclick="login()">Iniciar Sesi√≥n</button>
                        <button onclick="register()">Registrarse</button>
                        <button onclick="logout()">Cerrar Sesi√≥n</button>
                    </div>
                    <div id="user-info" style="display: none;">
                        <p>Conectado como: <span id="user-email"></span></p>
                    </div>
                </div>

                <!-- Secci√≥n de Jugadores -->
                <div class="section">
                    <h2>üë• Jugadores Conectados</h2>
                    <div id="players-list" class="player-list">
                        <!-- Lista de jugadores se cargar√° aqu√≠ -->
                    </div>
                    <button onclick="createGame()" id="create-game-btn" disabled>Crear Nueva Partida</button>
                </div>
            </div>

            <!-- Secci√≥n del Juego -->
            <div class="game-section">
                <div class="section">
                    <h2>üéÆ Tablero de Damas</h2>
                    <div class="game-info">
                        <p>Estado: <span id="game-status">Esperando jugadores...</span></p>
                        <p>Turno actual: <span id="current-turn" class="current-player">-</span></p>
                        <p>Tu color: <span id="player-color">-</span></p>
                    </div>
                    <div class="board" id="game-board">
                        <!-- Tablero se generar√° din√°micamente -->
                    </div>
                </div>
            </div>

            <!-- Secci√≥n de Chat -->
            <div class="players-section">
                <div class="section">
                    <h2>üí¨ Chat de la Partida</h2>
                    <div id="chat-messages" class="chat-box">
                        <!-- Mensajes del chat -->
                    </div>
                    <input type="text" id="chat-input" placeholder="Escribe un mensaje..." onkeypress="handleChatKeypress(event)" />
                    <button onclick="sendMessage()">Enviar</button>
                </div>

                <div class="section">
                    <h2>üìä Informaci√≥n de la Partida</h2>
                    <div id="game-stats">
                        <p>Jugador Rojo: <span id="red-player">-</span></p>
                        <p>Jugador Negro: <span id="black-player">-</span></p>
                        <p>Piezas rojas: <span id="red-pieces">12</span></p>
                        <p>Piezas negras: <span id="black-pieces">12</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuraci√≥n de Firebase - ¬°REEMPLAZA CON TUS PROPIAS CREDENCIALES!
        const firebaseConfig = {
            apiKey: "AIzaSyCPf1geb9QeaqqMWxWE1cHz2JksuHwyHJs",
            authDomain: "granjatrx.firebaseapp.com",
            databaseURL: "https://granjatrx-default-rtdb.firebaseio.com/",
            projectId: "granjatrx",
            storageBucket: "granjatrx.firebasestorage.app",
            messagingSenderId: "902775659198",
            appId: "1:902775659198:web:d5c4bb757f8e76c86bdcef",
            measurementId: "G-EQL3B8E74W"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // Variables globales del juego
        let currentUser = null;
        let currentGame = null;
        let playerColor = null;
        let selectedPiece = null;
        let possibleMoves = [];

        // Inicializar la aplicaci√≥n
        function init() {
            createBoard();
            setupAuthListener();
            setupGameListeners();
        }

        // Configurar listener de autenticaci√≥n
        function setupAuthListener() {
            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = user;
                    document.getElementById('user-email').textContent = user.email;
                    document.getElementById('auth-buttons').style.display = 'none';
                    document.getElementById('user-info').style.display = 'block';
                    document.getElementById('create-game-btn').disabled = false;
                    
                    // Registrar usuario en la lista de jugadores
                    registerPlayer(user);
                    loadOnlinePlayers();
                } else {
                    currentUser = null;
                    document.getElementById('auth-buttons').style.display = 'block';
                    document.getElementById('user-info').style.display = 'none';
                    document.getElementById('create-game-btn').disabled = true;
                }
            });
        }

        // Funciones de autenticaci√≥n
        function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            auth.signInWithEmailAndPassword(email, password)
                .catch((error) => {
                    alert('Error al iniciar sesi√≥n: ' + error.message);
                });
        }

        function register() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            auth.createUserWithEmailAndPassword(email, password)
                .catch((error) => {
                    alert('Error al registrarse: ' + error.message);
                });
        }

        function logout() {
            if (currentGame) {
                leaveGame();
            }
            auth.signOut();
        }

        // Gesti√≥n de jugadores online
        function registerPlayer(user) {
            const playerRef = database.ref('players/' + user.uid);
            playerRef.set({
                email: user.email,
                online: true,
                lastOnline: firebase.database.ServerValue.TIMESTAMP
            });

            playerRef.onDisconnect().update({
                online: false,
                lastOnline: firebase.database.ServerValue.TIMESTAMP
            });
        }

        function loadOnlinePlayers() {
            const playersRef = database.ref('players');
            playersRef.on('value', (snapshot) => {
                const players = snapshot.val();
                const playersList = document.getElementById('players-list');
                playersList.innerHTML = '';

                if (players) {
                    Object.keys(players).forEach((uid) => {
                        if (players[uid].online && uid !== currentUser.uid) {
                            const playerItem = document.createElement('div');
                            playerItem.className = 'player-item';
                            playerItem.innerHTML = `
                                ${players[uid].email}
                                <button onclick="joinGame('${uid}')">Unirse</button>
                            `;
                            playersList.appendChild(playerItem);
                        }
                    });
                }
            });
        }

        // Gesti√≥n del juego
        function createGame() {
            const gameId = generateGameId();
            currentGame = gameId;
            playerColor = 'red'; // El creador es siempre rojo

            const gameRef = database.ref('games/' + gameId);
            gameRef.set({
                playerRed: currentUser.uid,
                playerBlack: null,
                currentTurn: 'red',
                board: getInitialBoard(),
                status: 'waiting',
                created: firebase.database.ServerValue.TIMESTAMP
            });

            setupGameListener(gameId);
        }

        function joinGame(opponentUid) {
            // Buscar si el oponente tiene un juego esperando
            const gamesRef = database.ref('games');
            gamesRef.orderByChild('playerRed').equalTo(opponentUid).once('value')
                .then((snapshot) => {
                    let gameFound = null;
                    
                    snapshot.forEach((game) => {
                        if (game.val().status === 'waiting') {
                            gameFound = game;
                            return true;
                        }
                    });

                    if (gameFound) {
                        currentGame = gameFound.key;
                        playerColor = 'black';
                        
                        const gameRef = database.ref('games/' + gameFound.key);
                        gameRef.update({
                            playerBlack: currentUser.uid,
                            status: 'playing'
                        });

                        setupGameListener(gameFound.key);
                    } else {
                        alert('No se encontr√≥ partida disponible para unirse');
                    }
                });
        }

        function leaveGame() {
            if (currentGame) {
                const gameRef = database.ref('games/' + currentGame);
                gameRef.update({
                    status: 'finished'
                });
                currentGame = null;
                playerColor = null;
                resetBoard();
            }
        }

        function setupGameListener(gameId) {
            const gameRef = database.ref('games/' + gameId);
            gameRef.on('value', (snapshot) => {
                const game = snapshot.val();
                if (!game) return;

                updateGameUI(game);
                
                if (game.status === 'finished') {
                    gameRef.off();
                    currentGame = null;
                    playerColor = null;
                }
            });
        }

        function setupGameListeners() {
            // Escuchar invitaciones a partidas
            const gamesRef = database.ref('games');
            gamesRef.orderByChild('playerBlack').equalTo(null).on('child_added', (snapshot) => {
                const game = snapshot.val();
                if (game.playerRed !== currentUser?.uid) {
                    // Aqu√≠ podr√≠as mostrar una notificaci√≥n de invitaci√≥n
                    console.log('Nueva partida disponible:', game);
                }
            });
        }

        // L√≥gica del tablero y juego
        function createBoard() {
            const board = document.getElementById('game-board');
            board.innerHTML = '';
            
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    const cell = document.createElement('div');
                    cell.className = `cell ${(row + col) % 2 === 0 ? 'light' : 'dark'}`;
                    cell.dataset.row = row;
                    cell.dataset.col = col;
                    
                    cell.addEventListener('click', () => handleCellClick(row, col));
                    board.appendChild(cell);
                }
            }
        }

        function getInitialBoard() {
            const board = Array(8).fill().map(() => Array(8).fill(null));
            
            // Colocar piezas rojas (parte superior)
            for (let row = 0; row < 3; row++) {
                for (let col = 0; col < 8; col++) {
                    if ((row + col) % 2 === 1) {
                        board[row][col] = { type: 'pawn', color: 'red' };
                    }
                }
            }
            
            // Colocar piezas negras (parte inferior)
            for (let row = 5; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    if ((row + col) % 2 === 1) {
                        board[row][col] = { type: 'pawn', color: 'black' };
                    }
                }
            }
            
            return board;
        }

        function updateGameUI(game) {
            // Actualizar informaci√≥n del juego
            document.getElementById('game-status').textContent = 
                game.status === 'waiting' ? 'Esperando oponente...' : 
                game.status === 'playing' ? 'Partida en curso' : 'Partida finalizada';
            
            document.getElementById('current-turn').textContent = game.currentTurn;
            document.getElementById('player-color').textContent = playerColor;
            
            // Actualizar informaci√≥n de jugadores
            if (game.playerRed) {
                database.ref('players/' + game.playerRed).once('value')
                    .then(snap => {
                        document.getElementById('red-player').textContent = snap.val().email;
                    });
            }
            if (game.playerBlack) {
                database.ref('players/' + game.playerBlack).once('value')
                    .then(snap => {
                        document.getElementById('black-player').textContent = snap.val().email;
                    });
            }

            // Actualizar tablero
            renderBoard(game.board);
            
            // Contar piezas
            countPieces(game.board);
        }

        function renderBoard(board) {
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    const cell = document.querySelector(`.cell[data-row="${row}"][data-col="${col}"]`);
                    cell.innerHTML = '';
                    
                    if (board[row][col]) {
                        const piece = document.createElement('div');
                        piece.className = `piece ${board[row][col].color} ${board[row][col].type === 'king' ? 'king' : ''}`;
                        cell.appendChild(piece);
                    }
                }
            }
        }

        function handleCellClick(row, col) {
            if (!currentGame || playerColor === null) return;
            
            const gameRef = database.ref('games/' + currentGame);
            gameRef.once('value').then((snapshot) => {
                const game = snapshot.val();
                if (game.currentTurn !== playerColor || game.status !== 'playing') return;

                const board = game.board;
                const piece = board[row][col];

                if (piece && piece.color === playerColor) {
                    // Seleccionar pieza
                    selectedPiece = { row, col };
                    possibleMoves = calculatePossibleMoves(board, row, col);
                    highlightPossibleMoves(possibleMoves);
                } else if (selectedPiece) {
                    // Mover pieza
                    const move = possibleMoves.find(m => m.toRow === row && m.toCol === col);
                    if (move) {
                        makeMove(gameRef, board, selectedPiece.row, selectedPiece.col, row, col, move.captures);
                    }
                    selectedPiece = null;
                    clearHighlights();
                }
            });
        }

        function calculatePossibleMoves(board, row, col) {
            const piece = board[row][col];
            const moves = [];
            const directions = piece.type === 'king' ? 
                [[-1, -1], [-1, 1], [1, -1], [1, 1]] : 
                piece.color === 'red' ? [[1, -1], [1, 1]] : [[-1, -1], [-1, 1]];

            // Movimientos simples y capturas
            for (const [dr, dc] of directions) {
                const newRow = row + dr;
                const newCol = col + dc;
                
                if (isValidPosition(newRow, newCol)) {
                    if (!board[newRow][newCol]) {
                        moves.push({ toRow: newRow, toCol: newCol, captures: [] });
                    } else if (board[newRow][newCol].color !== piece.color) {
                        const jumpRow = newRow + dr;
                        const jumpCol = newCol + dc;
                        if (isValidPosition(jumpRow, jumpCol) && !board[jumpRow][jumpCol]) {
                            moves.push({ 
                                toRow: jumpRow, 
                                toCol: jumpCol, 
                                captures: [{row: newRow, col: newCol}] 
                            });
                        }
                    }
                }
            }

            return moves;
        }

        function isValidPosition(row, col) {
            return row >= 0 && row < 8 && col >= 0 && col < 8;
        }

        function highlightPossibleMoves(moves) {
            moves.forEach(move => {
                const cell = document.querySelector(`.cell[data-row="${move.toRow}"][data-col="${move.toCol}"]`);
                cell.classList.add('possible-move');
            });
        }

        function clearHighlights() {
            document.querySelectorAll('.cell.possible-move').forEach(cell => {
                cell.classList.remove('possible-move');
            });
        }

        function makeMove(gameRef, board, fromRow, fromCol, toRow, toCol, captures) {
            const newBoard = JSON.parse(JSON.stringify(board));
            const piece = newBoard[fromRow][fromCol];

            // Mover pieza
            newBoard[toRow][toCol] = piece;
            newBoard[fromRow][fromCol] = null;

            // Coronar si llega al final
            if ((piece.color === 'red' && toRow === 7) || (piece.color === 'black' && toRow === 0)) {
                newBoard[toRow][toCol].type = 'king';
            }

            // Eliminar piezas capturadas
            captures.forEach(capture => {
                newBoard[capture.row][capture.col] = null;
            });

            // Cambiar turno
            const nextTurn = piece.color === 'red' ? 'black' : 'red';

            gameRef.update({
                board: newBoard,
                currentTurn: nextTurn
            });

            // Verificar fin del juego
            checkGameEnd(gameRef, newBoard, nextTurn);
        }

        function checkGameEnd(gameRef, board, currentTurn) {
            const pieces = { red: 0, black: 0 };
            
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    if (board[row][col]) {
                        pieces[board[row][col].color]++;
                    }
                }
            }

            if (pieces.red === 0 || pieces.black === 0) {
                gameRef.update({
                    status: 'finished',
                    winner: pieces.red === 0 ? 'black' : 'red'
                });
            }
        }

        function countPieces(board) {
            let redCount = 0;
            let blackCount = 0;

            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    if (board[row][col]) {
                        if (board[row][col].color === 'red') redCount++;
                        else blackCount++;
                    }
                }
            }

            document.getElementById('red-pieces').textContent = redCount;
            document.getElementById('black-pieces').textContent = blackCount;
        }

        function resetBoard() {
            createBoard();
            document.getElementById('game-status').textContent = 'Esperando jugadores...';
            document.getElementById('current-turn').textContent = '-';
            document.getElementById('player-color').textContent = '-';
        }

        // Chat functions
        function handleChatKeypress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (message && currentGame && currentUser) {
                const chatRef = database.ref('games/' + currentGame + '/chat');
                chatRef.push({
                    sender: currentUser.email,
                    message: message,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                
                input.value = '';
            }
        }

        // Utility functions
        function generateGameId() {
            return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        }

        // Inicializar la aplicaci√≥n cuando se carga la p√°gina
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
