<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Damas Online con Apuestas</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #166088;
            --accent-color: #4cb5ae;
            --dark-color: #2d3047;
            --light-color: #f8f9fa;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --board-light: #f0d9b5;
            --board-dark: #b58863;
            --piece-light: #ffffff;
            --piece-dark: #000000;
            --king-light: #ffeb3b;
            --king-dark: #8b4513;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, var(--dark-color), var(--secondary-color));
            color: var(--light-color);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
        }

        header {
            grid-column: 1 / -1;
            text-align: center;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            margin-bottom: 20px;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(to right, var(--accent-color), var(--primary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .game-area {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .game-board {
            background: var(--board-light);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
            aspect-ratio: 1/1;
            max-width: 600px;
            margin: 0 auto;
        }

        .cell {
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .cell.light {
            background-color: var(--board-light);
        }

        .cell.dark {
            background-color: var(--board-dark);
        }

        .cell.valid-move::after {
            content: '';
            position: absolute;
            width: 30%;
            height: 30%;
            border-radius: 50%;
            background-color: rgba(76, 181, 174, 0.5);
        }

        .cell.selected {
            box-shadow: inset 0 0 0 3px var(--accent-color);
        }

        .piece {
            width: 80%;
            height: 80%;
            border-radius: 50%;
            cursor: pointer;
            position: relative;
            transition: transform 0.3s;
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.3);
        }

        .piece.player1 {
            background: linear-gradient(145deg, var(--piece-light), #d9d9d9);
        }

        .piece.player2 {
            background: linear-gradient(145deg, var(--piece-dark), #333333);
        }

        .piece.king::after {
            content: '♔';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5rem;
            color: var(--king-light);
        }

        .piece.player2.king::after {
            color: var(--king-dark);
        }

        .piece.selected {
            transform: scale(1.1);
            box-shadow: 0 0 10px var(--accent-color);
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .panel h2 {
            margin-bottom: 15px;
            color: var(--accent-color);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 10px;
        }

        .user-info {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .balance {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent-color);
        }

        .betting-area {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .bet-input {
            display: flex;
            gap: 10px;
        }

        .bet-input input {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .bet-input button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            background: var(--accent-color);
            color: white;
            cursor: pointer;
            transition: background 0.3s;
        }

        .bet-input button:hover {
            background: #3a9c96;
        }

        .bet-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .bet-option {
            padding: 10px;
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .bet-option:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .bet-option.selected {
            background: var(--accent-color);
        }

        .game-info {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .status {
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }

        .status.waiting {
            background: var(--warning-color);
            color: var(--dark-color);
        }

        .status.playing {
            background: var(--success-color);
        }

        .status.finished {
            background: var(--primary-color);
        }

        .players {
            display: flex;
            justify-content: space-between;
        }

        .player {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .player.active {
            color: var(--accent-color);
            font-weight: bold;
        }

        .player-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }

        .player1 .player-icon {
            background: var(--piece-light);
        }

        .player2 .player-icon {
            background: var(--piece-dark);
        }

        .auth-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .auth-form input {
            padding: 10px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .auth-form button {
            padding: 10px;
            border: none;
            border-radius: 5px;
            background: var(--primary-color);
            color: white;
            cursor: pointer;
            transition: background 0.3s;
        }

        .auth-form button:hover {
            background: var(--secondary-color);
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
            
            .game-board {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Damas Online con Apuestas</h1>
            <p>Juega y apuesta desde 50 CUP hasta 1000 CUP</p>
        </header>

        <main class="game-area">
            <div class="game-board" id="gameBoard">
                <!-- El tablero se generará con JavaScript -->
            </div>
        </main>

        <aside class="sidebar">
            <div class="panel auth-section" id="authSection">
                <h2>Iniciar Sesión / Registrarse</h2>
                <div class="auth-form">
                    <input type="email" id="emailInput" placeholder="Correo electrónico">
                    <input type="password" id="passwordInput" placeholder="Contraseña">
                    <button id="loginBtn">Iniciar Sesión</button>
                    <button id="registerBtn">Registrarse</button>
                </div>
            </div>

            <div class="panel user-info hidden" id="userInfo">
                <h2>Información del Usuario</h2>
                <div id="userEmail"></div>
                <div class="balance" id="userBalance">0 CUP</div>
                <button id="logoutBtn">Cerrar Sesión</button>
            </div>

            <div class="panel betting-area hidden" id="bettingArea">
                <h2>Realizar Apuesta</h2>
                <div class="bet-input">
                    <input type="number" id="betAmount" min="50" max="1000" placeholder="Cantidad (50-1000 CUP)">
                    <button id="placeBetBtn">Apostar</button>
                </div>
                <div class="bet-options">
                    <div class="bet-option" data-amount="50">50 CUP</div>
                    <div class="bet-option" data-amount="100">100 CUP</div>
                    <div class="bet-option" data-amount="200">200 CUP</div>
                    <div class="bet-option" data-amount="300">300 CUP</div>
                    <div class="bet-option" data-amount="500">500 CUP</div>
                    <div class="bet-option" data-amount="1000">1000 CUP</div>
                </div>
            </div>

            <div class="panel game-info hidden" id="gameInfo">
                <h2>Información del Juego</h2>
                <div class="status" id="gameStatus">Esperando jugadores...</div>
                <div class="players">
                    <div class="player player1" id="player1Info">
                        <div class="player-icon"></div>
                        <div>Jugador 1</div>
                        <div id="player1Bet">Apuesta: 0 CUP</div>
                    </div>
                    <div class="player player2" id="player2Info">
                        <div class="player-icon"></div>
                        <div>Jugador 2</div>
                        <div id="player2Bet">Apuesta: 0 CUP</div>
                    </div>
                </div>
                <div id="gameRules">
                    <p><strong>Reglas:</strong> Las fichas deben comer obligatoriamente cuando es posible. Al llegar al final del tablero, coronan como reina y pueden moverse en cualquier dirección y distancia.</p>
                </div>
            </div>
        </aside>
    </div>

    <script>
        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "TU_API_KEY",
            authDomain: "TU_PROYECTO.firebaseapp.com",
            projectId: "TU_PROYECTO",
            storageBucket: "TU_PROYECTO.appspot.com",
            messagingSenderId: "TU_SENDER_ID",
            appId: "TU_APP_ID"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Variables del juego
        let currentUser = null;
        let userBalance = 0;
        let gameState = {
            board: [],
            currentPlayer: 1,
            selectedPiece: null,
            validMoves: [],
            gameStatus: 'waiting', // waiting, playing, finished
            players: {
                1: { uid: null, bet: 0 },
                2: { uid: null, bet: 0 }
            },
            winner: null
        };

        // Elementos del DOM
        const authSection = document.getElementById('authSection');
        const userInfo = document.getElementById('userInfo');
        const userEmail = document.getElementById('userEmail');
        const userBalanceElem = document.getElementById('userBalance');
        const bettingArea = document.getElementById('bettingArea');
        const gameInfo = document.getElementById('gameInfo');
        const gameBoard = document.getElementById('gameBoard');
        const betAmountInput = document.getElementById('betAmount');
        const placeBetBtn = document.getElementById('placeBetBtn');
        const betOptions = document.querySelectorAll('.bet-option');
        const gameStatus = document.getElementById('gameStatus');
        const player1Info = document.getElementById('player1Info');
        const player2Info = document.getElementById('player2Info');
        const player1Bet = document.getElementById('player1Bet');
        const player2Bet = document.getElementById('player2Bet');
        const loginBtn = document.getElementById('loginBtn');
        const registerBtn = document.getElementById('registerBtn');
        const logoutBtn = document.getElementById('logoutBtn');

        // Inicializar el tablero
        function initializeBoard() {
            gameBoard.innerHTML = '';
            gameState.board = [];
            
            // Crear el tablero vacío
            for (let row = 0; row < 8; row++) {
                gameState.board[row] = [];
                for (let col = 0; col < 8; col++) {
                    const cell = document.createElement('div');
                    cell.className = `cell ${(row + col) % 2 === 0 ? 'light' : 'dark'}`;
                    cell.dataset.row = row;
                    cell.dataset.col = col;
                    
                    cell.addEventListener('click', () => handleCellClick(row, col));
                    gameBoard.appendChild(cell);
                    
                    // Inicializar la posición en el estado del juego
                    gameState.board[row][col] = null;
                }
            }
            
            // Colocar las fichas iniciales
            setupInitialPieces();
        }

        // Configurar las fichas iniciales
        function setupInitialPieces() {
            // Fichas del jugador 1 (parte superior)
            for (let row = 0; row < 3; row++) {
                for (let col = 0; col < 8; col++) {
                    if ((row + col) % 2 === 1) {
                        addPiece(row, col, 1);
                    }
                }
            }
            
            // Fichas del jugador 2 (parte inferior)
            for (let row = 5; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    if ((row + col) % 2 === 1) {
                        addPiece(row, col, 2);
                    }
                }
            }
        }

        // Añadir una ficha al tablero
        function addPiece(row, col, player) {
            const cell = document.querySelector(`.cell[data-row="${row}"][data-col="${col}"]`);
            const piece = document.createElement('div');
            piece.className = `piece player${player}`;
            piece.dataset.player = player;
            cell.appendChild(piece);
            
            gameState.board[row][col] = {
                player: player,
                isKing: false
            };
        }

        // Manejar clic en una celda
        function handleCellClick(row, col) {
            if (gameState.gameStatus !== 'playing') return;
            if (gameState.players[gameState.currentPlayer].uid !== currentUser.uid) return;
            
            const piece = gameState.board[row][col];
            
            // Si hay una ficha seleccionada, intentar moverla
            if (gameState.selectedPiece) {
                const move = gameState.validMoves.find(m => 
                    m.toRow === row && m.toCol === col
                );
                
                if (move) {
                    movePiece(gameState.selectedPiece.row, gameState.selectedPiece.col, row, col);
                    if (move.captures) {
                        // Eliminar la ficha capturada
                        const captureRow = (gameState.selectedPiece.row + row) / 2;
                        const captureCol = (gameState.selectedPiece.col + col) / 2;
                        removePiece(captureRow, captureCol);
                        
                        // Verificar si hay más capturas posibles
                        const moreCaptures = getValidMoves(row, col).filter(m => m.captures);
                        if (moreCaptures.length > 0) {
                            // Permitir captura múltiple
                            gameState.selectedPiece = { row, col };
                            gameState.validMoves = moreCaptures;
                            highlightValidMoves();
                            return;
                        }
                    }
                    
                    // Cambiar de jugador
                    gameState.currentPlayer = gameState.currentPlayer === 1 ? 2 : 1;
                    gameState.selectedPiece = null;
                    gameState.validMoves = [];
                    clearHighlights();
                    
                    // Verificar si el juego ha terminado
                    checkGameEnd();
                    
                    // Actualizar la interfaz
                    updateGameUI();
                } else {
                    // Si se hace clic en otra ficha del mismo jugador, seleccionarla
                    if (piece && piece.player === gameState.currentPlayer) {
                        selectPiece(row, col);
                    } else {
                        // Deseleccionar la ficha actual
                        gameState.selectedPiece = null;
                        gameState.validMoves = [];
                        clearHighlights();
                    }
                }
            } else {
                // Seleccionar una ficha si pertenece al jugador actual
                if (piece && piece.player === gameState.currentPlayer) {
                    selectPiece(row, col);
                }
            }
        }

        // Seleccionar una ficha
        function selectPiece(row, col) {
            gameState.selectedPiece = { row, col };
            gameState.validMoves = getValidMoves(row, col);
            highlightValidMoves();
        }

        // Obtener movimientos válidos para una ficha
        function getValidMoves(row, col) {
            const piece = gameState.board[row][col];
            if (!piece) return [];
            
            const moves = [];
            const directions = piece.isKing ? 
                [[-1, -1], [-1, 1], [1, -1], [1, 1]] : 
                (piece.player === 1 ? [[1, -1], [1, 1]] : [[-1, -1], [-1, 1]]);
            
            // Verificar capturas obligatorias primero
            let hasCaptures = false;
            
            for (const [dr, dc] of directions) {
                let captureRow = row + dr;
                let captureCol = col + dc;
                let landingRow = row + 2 * dr;
                let landingCol = col + 2 * dc;
                
                // Para reinas, verificar múltiples saltos
                if (piece.isKing) {
                    let currentRow = row + dr;
                    let currentCol = col + dc;
                    
                    while (currentRow >= 0 && currentRow < 8 && currentCol >= 0 && currentCol < 8) {
                        if (gameState.board[currentRow][currentCol]) {
                            if (gameState.board[currentRow][currentCol].player !== piece.player) {
                                // Encontrar la celda de aterrizaje después de la captura
                                let nextRow = currentRow + dr;
                                let nextCol = currentCol + dc;
                                
                                while (nextRow >= 0 && nextRow < 8 && nextCol >= 0 && nextCol < 8) {
                                    if (!gameState.board[nextRow][nextCol]) {
                                        moves.push({
                                            toRow: nextRow,
                                            toCol: nextCol,
                                            captures: { row: currentRow, col: currentCol }
                                        });
                                        hasCaptures = true;
                                    } else {
                                        break;
                                    }
                                    nextRow += dr;
                                    nextCol += dc;
                                }
                            }
                            break;
                        }
                        currentRow += dr;
                        currentCol += dc;
                    }
                } else {
                    // Para fichas normales
                    if (landingRow >= 0 && landingRow < 8 && landingCol >= 0 && landingCol < 8) {
                        const capturePiece = gameState.board[captureRow][captureCol];
                        const landingPiece = gameState.board[landingRow][landingCol];
                        
                        if (capturePiece && capturePiece.player !== piece.player && !landingPiece) {
                            moves.push({
                                toRow: landingRow,
                                toCol: landingCol,
                                captures: { row: captureRow, col: captureCol }
                            });
                            hasCaptures = true;
                        }
                    }
                }
            }
            
            // Si hay capturas, solo permitir movimientos de captura
            if (hasCaptures) {
                return moves;
            }
            
            // Si no hay capturas, permitir movimientos normales
            for (const [dr, dc] of directions) {
                if (piece.isKing) {
                    // Para reinas, permitir movimientos a lo largo de la diagonal
                    let currentRow = row + dr;
                    let currentCol = col + dc;
                    
                    while (currentRow >= 0 && currentRow < 8 && currentCol >= 0 && currentCol < 8) {
                        if (!gameState.board[currentRow][currentCol]) {
                            moves.push({
                                toRow: currentRow,
                                toCol: currentCol,
                                captures: null
                            });
                        } else {
                            break;
                        }
                        currentRow += dr;
                        currentCol += dc;
                    }
                } else {
                    // Para fichas normales, solo un movimiento
                    const newRow = row + dr;
                    const newCol = col + dc;
                    
                    if (newRow >= 0 && newRow < 8 && newCol >= 0 && newCol < 8) {
                        if (!gameState.board[newRow][newCol]) {
                            moves.push({
                                toRow: newRow,
                                toCol: newCol,
                                captures: null
                            });
                        }
                    }
                }
            }
            
            return moves;
        }

        // Resaltar movimientos válidos
        function highlightValidMoves() {
            clearHighlights();
            
            // Resaltar la ficha seleccionada
            const selectedCell = document.querySelector(
                `.cell[data-row="${gameState.selectedPiece.row}"][data-col="${gameState.selectedPiece.col}"]`
            );
            selectedCell.classList.add('selected');
            
            // Resaltar los movimientos válidos
            gameState.validMoves.forEach(move => {
                const cell = document.querySelector(
                    `.cell[data-row="${move.toRow}"][data-col="${move.toCol}"]`
                );
                cell.classList.add('valid-move');
            });
        }

        // Limpiar resaltados
        function clearHighlights() {
            document.querySelectorAll('.cell.selected, .cell.valid-move').forEach(cell => {
                cell.classList.remove('selected', 'valid-move');
            });
        }

        // Mover una ficha
        function movePiece(fromRow, fromCol, toRow, toCol) {
            const piece = gameState.board[fromRow][fromCol];
            gameState.board[fromRow][fromCol] = null;
            gameState.board[toRow][toCol] = piece;
            
            // Actualizar la interfaz
            const fromCell = document.querySelector(
                `.cell[data-row="${fromRow}"][data-col="${fromCol}"]`
            );
            const toCell = document.querySelector(
                `.cell[data-row="${toRow}"][data-col="${toCol}"]`
            );
            
            const pieceElement = fromCell.querySelector('.piece');
            fromCell.removeChild(pieceElement);
            toCell.appendChild(pieceElement);
            
            // Coronar si llega al final del tablero
            if ((piece.player === 1 && toRow === 7) || (piece.player === 2 && toRow === 0)) {
                piece.isKing = true;
                pieceElement.classList.add('king');
            }
        }

        // Eliminar una ficha
        function removePiece(row, col) {
            gameState.board[row][col] = null;
            const cell = document.querySelector(
                `.cell[data-row="${row}"][data-col="${col}"]`
            );
            const piece = cell.querySelector('.piece');
            if (piece) cell.removeChild(piece);
        }

        // Verificar si el juego ha terminado
        function checkGameEnd() {
            // Verificar si un jugador no tiene fichas
            let player1Pieces = 0;
            let player2Pieces = 0;
            let player1CanMove = false;
            let player2CanMove = false;
            
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    const piece = gameState.board[row][col];
                    if (piece) {
                        if (piece.player === 1) {
                            player1Pieces++;
                            if (getValidMoves(row, col).length > 0) player1CanMove = true;
                        } else {
                            player2Pieces++;
                            if (getValidMoves(row, col).length > 0) player2CanMove = true;
                        }
                    }
                }
            }
            
            if (player1Pieces === 0 || !player1CanMove) {
                gameState.gameStatus = 'finished';
                gameState.winner = 2;
                endGame();
            } else if (player2Pieces === 0 || !player2CanMove) {
                gameState.gameStatus = 'finished';
                gameState.winner = 1;
                endGame();
            }
        }

        // Finalizar el juego y procesar pagos
        function endGame() {
            gameStatus.textContent = `¡Jugador ${gameState.winner} ha ganado!`;
            gameStatus.className = 'status finished';
            
            // Procesar pagos
            if (gameState.winner && currentUser) {
                const winnerBet = gameState.players[gameState.winner].bet;
                const totalPot = gameState.players[1].bet + gameState.players[2].bet;
                const commission = totalPot * 0.05; // 5% de comisión
                const winnerPayout = totalPot - commission;
                
                if (gameState.players[gameState.winner].uid === currentUser.uid) {
                    // El usuario actual ganó
                    userBalance += winnerPayout;
                    updateUserBalance();
                    
                    // Actualizar en Firebase
                    db.collection('users').doc(currentUser.uid).update({
                        balance: userBalance
                    });
                }
            }
        }

        // Actualizar la interfaz de usuario del juego
        function updateGameUI() {
            // Actualizar información de los jugadores
            player1Info.classList.toggle('active', gameState.currentPlayer === 1);
            player2Info.classList.toggle('active', gameState.currentPlayer === 2);
            
            player1Bet.textContent = `Apuesta: ${gameState.players[1].bet} CUP`;
            player2Bet.textContent = `Apuesta: ${gameState.players[2].bet} CUP`;
            
            // Actualizar estado del juego
            if (gameState.gameStatus === 'waiting') {
                gameStatus.textContent = 'Esperando jugadores...';
                gameStatus.className = 'status waiting';
            } else if (gameState.gameStatus === 'playing') {
                gameStatus.textContent = `Turno del Jugador ${gameState.currentPlayer}`;
                gameStatus.className = 'status playing';
            }
        }

        // Actualizar el saldo del usuario en la interfaz
        function updateUserBalance() {
            userBalanceElem.textContent = `${userBalance} CUP`;
        }

        // Manejar la apuesta
        function placeBet(amount) {
            if (!currentUser) return;
            
            amount = parseInt(amount);
            if (amount < 50 || amount > 1000) {
                alert('La apuesta debe estar entre 50 y 1000 CUP');
                return;
            }
            
            if (userBalance < amount) {
                alert('Saldo insuficiente');
                return;
            }
            
            // Restar la apuesta del saldo
            userBalance -= amount;
            updateUserBalance();
            
            // Asignar al jugador
            const playerSlot = gameState.players[1].uid ? 2 : 1;
            gameState.players[playerSlot] = {
                uid: currentUser.uid,
                bet: amount
            };
            
            // Actualizar en Firebase
            db.collection('users').doc(currentUser.uid).update({
                balance: userBalance
            });
            
            // Si ambos jugadores han apostado, comenzar el juego
            if (gameState.players[1].uid && gameState.players[2].uid) {
                gameState.gameStatus = 'playing';
                gameState.currentPlayer = 1;
            }
            
            updateGameUI();
            
            // Ocultar área de apuestas si ya se apostó
            if (gameState.players[1].uid === currentUser.uid || gameState.players[2].uid === currentUser.uid) {
                bettingArea.classList.add('hidden');
            }
        }

        // Event Listeners
        loginBtn.addEventListener('click', () => {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    currentUser = userCredential.user;
                    loadUserData();
                })
                .catch((error) => {
                    alert('Error al iniciar sesión: ' + error.message);
                });
        });

        registerBtn.addEventListener('click', () => {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            
            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    currentUser = userCredential.user;
                    
                    // Crear documento de usuario en Firestore
                    return db.collection('users').doc(currentUser.uid).set({
                        email: currentUser.email,
                        balance: 1000, // Saldo inicial
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                })
                .then(() => {
                    loadUserData();
                })
                .catch((error) => {
                    alert('Error al registrarse: ' + error.message);
                });
        });

        logoutBtn.addEventListener('click', () => {
            auth.signOut().then(() => {
                currentUser = null;
                userBalance = 0;
                resetGame();
                showAuthSection();
            });
        });

        placeBetBtn.addEventListener('click', () => {
            const amount = betAmountInput.value;
            placeBet(amount);
        });

        betOptions.forEach(option => {
            option.addEventListener('click', () => {
                betOptions.forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
                betAmountInput.value = option.dataset.amount;
            });
        });

        // Cargar datos del usuario
        function loadUserData() {
            db.collection('users').doc(currentUser.uid).get()
                .then((doc) => {
                    if (doc.exists) {
                        userBalance = doc.data().balance;
                        updateUserBalance();
                        userEmail.textContent = doc.data().email;
                        showGameSection();
                    }
                })
                .catch((error) => {
                    console.error('Error al cargar datos del usuario:', error);
                });
        }

        // Mostrar sección de autenticación
        function showAuthSection() {
            authSection.classList.remove('hidden');
            userInfo.classList.add('hidden');
            bettingArea.classList.add('hidden');
            gameInfo.classList.add('hidden');
        }

        // Mostrar sección del juego
        function showGameSection() {
            authSection.classList.add('hidden');
            userInfo.classList.remove('hidden');
            bettingArea.classList.remove('hidden');
            gameInfo.classList.remove('hidden');
        }

        // Reiniciar el juego
        function resetGame() {
            gameState = {
                board: [],
                currentPlayer: 1,
                selectedPiece: null,
                validMoves: [],
                gameStatus: 'waiting',
                players: {
                    1: { uid: null, bet: 0 },
                    2: { uid: null, bet: 0 }
                },
                winner: null
            };
            
            initializeBoard();
            updateGameUI();
            bettingArea.classList.remove('hidden');
        }

        // Observador de autenticación
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                loadUserData();
            } else {
                currentUser = null;
                showAuthSection();
            }
        });

        // Inicializar la aplicación
        initializeBoard();
        updateGameUI();
    </script>
</body>
</html>
